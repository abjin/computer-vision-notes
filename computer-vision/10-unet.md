# U-Net

- 동기
  1. 생채 의학 분할에서의 문제
    - 작고 라벨이 달린 데이터셋
    - 픽셀 단위의 분류의 필요성 (시멘틱 분할)
    - 전역적 시멘틱 이해와 정밀한 공간 경계 보존이 필수적
  2. 슬라이딩 윈도우 CNN (patch-to-patch) 의 한계
    - 비효율적 연산
      - 이웃한 패치들이 많이 겹쳐서 연산이 중복됨
      - 겹치는 영역에 공유된 연산을 사용할 수 없음
    - 패치 크기에 따른 맥락-위치 추정 트레이드 오프
      - 큰 패치 -> 맥락은 포착, 위치 손실
      - 작은 패치 -> 위치 포착, 맥락 손실

- U-Net 의 접근 방식
  1. FCN
  2. 인코더 디코더
    1. 인코더, 수축 경로(Contracting Path): 맥락 포착
    2. 디코더, 확장 경로(Expansive Path): 정밀한 위치 추정
  3. 스킵
    - 얕은 레이어의 미세 디테일과 깊은 레이어의 시멘틱 정보 결합

# U-Net 아키텍쳐
## U-Net 아키텍쳐 - 인코더

- 목적
  - 채널 수를 늘려 맥락 포착하기

- 단계별 구조
  1. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬
    - 채널 수 2배로 확장: $1 \rightarrow 64 \rightarrow 128 \rightarrow 256 \rightarrow 512$
  2. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬
  3. 다운 샘플링을 위한 2x2 MaxPooling (stride=2)
    - 풀링은 수용영역을 증가 시켜 네트워크가 더 많은 맥락을 포착하도록함.

## U-Net 아키텍쳐 - 병목

- 목적
  - 인코더와 디코더 사이를 연결

- 단계별 구조
  1. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬
    - 채널 수 2배로 확장: $512 \rightarrow 1024$
  2. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬

- 특징
  - 드롭아웃을 적용하여 과적합을 방지하고 노이즈에 견고하게 함.
  - 이 계층은 가장 높은 채널 수와 가장 작은 공간 해상도를 가짐.
  - 입력의 가장 추상적이 표현을 포함함.

## U-Net 아키텍쳐 - 디코더

- 목적
  - 공간 해상도 복원

- 단계별 구조
  1. 2x2 Deconvolution (Upsampling)
    - 특징 맵 2배 확대 채널 수 2배 감소
  2. 자르기 및 연결
    - 대응하는 인코더에 특징 맵을 가져옴
    - 인코더에서 가져온 특징 맵을 디코더 특징 맵 크기에 마추어 자름 (인코더의 특징맵이 더 작음)
    - 크기가 같아진 2개의 특징 맵을 채널 축으로 결합 (concatenate)
  3. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬
    - 채널 수 반으로 축소
  4. 3x3 Conv(stride=1,padding=0) -> ReLU -> BatchNorm
    - 맵 크기가 2씩 줄어듬

## U-Net 아키텍쳐 - 출력 레이어

- 목적
  - 1x1 conv 를 사용해 밀집 예측 생성

- 단계별 구조
  - 1x1 conv 를 사용해 밀집 예측 생성 (필터수: C, C 는 클래스 수와 동일)

## U-Net 아키텍쳐 - 스킵 연결

- 목적
  - 저수준 공간 디테일 특징 + 고수준 시맨틱 특징 결합함

- 단계별 구조
  - 대응하는 인코더에 특징 맵을 가져옴
  - 인코더에서 가져온 특징 맵을 디코더 특징 맵 크기에 마추어 자름 (인코더의 특징맵이 더 작음)
  - 크기가 같아진 2개의 특징 맵을 채널 축으로 결합 (concatenate)


# U-Net 핵심 아이디어
## 인코더 - 디코더

- 인코더
  - Conv + 풀링을 사용하여 특징 맵을 줄임 (W x H → w x h)
  - 고수준 시맨틱을 추출
- 디코더
  - 업샘플링을 사용하여 특징 맵을 원래 크기로 복원 (w x h → W x H).
  - 각 픽셀이 클래스 라벨을 밀집 예측 생성

## FCN: Fully Convolution Network

- 목표
  - 이미지의 모든 픽셀에 클래스 라벨 할당 (시멘틱 분할 수행)
  - 입력 이미지 부터 밀집 출력까지 end-to-end 학습.
  - 시맨틱 의미와 공간적 정밀도 균형 유지

- 기존 FC 문제점
  1. 공간 정보의 손실
  2. 입력 크기가 고정되어 있음
  3. 밀집 예측을 하려면 출력이 너무 커침

- 핵심 아이디어
  - FC 계층을 Conv 계층으로 교체
    - VGG16 의 첫 번째 FC 계층 -> 동일한 파라미터 수를 가진 7x7 계층으로 변환
    - 마지막 계층: 채널수 = 클래스 수 인 1x1 Conv 계층으로 변환

- 특징
  - 임의 크기의 입력을 허용
  - 입력에 상응하는 공간 크기의 출력을 생성
  - 효율적으로 전체 이미지 추론 및 학습 가능 (patch-by-patch 처리보다 5배 속도 향상)

## 업샘플링

- FCN 에서의 문제점
  - FCN 은 공간적 배치는 보존하지만 여전히 해상도가 거침

- 업샘플링 방법들 (Upsampling Methods)
  1. 고정된 방식
    - 쌍건형 보간법: 단순하고 학습 불가능 (거리에 가중치를 주어 평균을 내서 채움 )
    - 언풀링: 풀링할때 가장 큰 값의 위치를 기억. 그 위치의 값만 복원, 나머지 값은 0으로 채움
  2. 학습 가능한 방식
    - 디컨볼루션 (Backwards Conv): 학습중 파라미터가 학습됨

- 역방향 Conv 개념
  - 학습 가능한 필터를 사용하여 Conv 연산을 반대로 수행해 공간의 크기를 늘림

- FCN 에서의 사용
  1. FCN 은 거친 특징 맵을 입력 크기로 업샘플링 하기위해 디컨볼루션을 사용
  2. 초기 가중치는 쌍건형 보간법 값으로 설정
  3. 학습 과정에서 이 가중치들이 업데이트 되어 정확도를 향상시킴
  4. 픽셀 단위 손실 함수 계산을 통해 엔드 투 엔드 학습

## 스킵 아키텍쳐

- 동기
  - 스트라이드가 큰 경우
    - 학습 가능한 디컨볼루션을 쓰더라도 스트라이드가 큰 경우 상세한 공간 정보 손실
    - 이는 흐릿하고 부정확한 경계를 초례
  - 깊은 층의 넓은 수용 영역
    - 네트워크의 깊은 층은 넓은 수용 영역으로 이미지의 광범위한 영역을 한 번에 요약
    - 그 과정에서 객체의 정밀한 경계와 같은 세부적인 위치 정보가 손실

- 스킵 연결이란
  - 인코더 레이어를 대응하는 디코더에 직접 연결
  - 인코더의 저수준 공간 디테일과 디코더의 시멘틱 정보를 병합

- 장점
  - 선명한 객체 경계를 복원하고 지역성과 공간 정보를 보존함
  - 정확한 분할을 위해 공간 정보+ 시멘틱 맥락을 결합
# U-Net 학습 전략

- **오버랩-타일 전략**
  - 목적
    - U-Net 은 메모리 제약 때문에 고해상도 의료 의미지를 한번에 처리하기 어려움
    - U-Net 은 출력이 입력보다 작아지는 문제가 있음
    - 큰 이미지를 조각으로 나누어 처리때 경계선 부분의 예측 정확도를 높이기 위해 오버랩 타일 전략 사용
  - 작동 방식
    1. 이미지를 겹치는 타일로 분할
    2. 각 타일을 U-Net 으로 예측
    3. 출력은 입력보다 작으므로, 중앙 부분만 남김
    4. 각 타일에서 나온 유효한 중앙 부분의 결과들을 이어 붙여 최종 분할 맵 생성
  - 효과
    - 타일을 겹치지 않게 짤라 경계 부분의 맥락을 유지
    - 타일의 경게선 부분에서 발생하는 왜곡 현상 즉 Border Artifacts 를 방지

- **미러링 외산법**
  - 목적
    - Conv 연산시 경계 부분의 픽셀들은 정보가 부족
    - 보통 0 padding 을 사용하는데. 이는 이미지에 없던 경계선을 만들어 예측을 방해
    - 인공적인 padding 값 대신 미러링 외산법을 사용해 경계부분에 맥락을 제공
  - 작동 방식
    1. 이미지의 경계 부분을 거울처럼 반사시켜 이미지를 확장
    2. 타일링 전 미러링된 확장이 원본 이미지를 감쌈
  - 효과
    - 가장자리의 텍스처를 보존하여 네트워크가 가장자리에 있는 객체의 경계도 잘 학습할 수 있도록함.

- **가중 손실 (경계 분리를 위한)**
  - 목적
    - 생체 의학 이미지에서는 세포와 같은 객체들이 바싹 붙어 있거나 겹쳐있는 경우가 많음
    - 경계 분리를 위한 가중 손실은 객체가 맞닿아 있거나 경계가 얇은 영역에서의 분할 기능을 향상 시키기 위해 사용
  - 작동 방식
    1. 가중치 맵 계산
      - Ground Truth 를 이용해. 가중치 맵이라는 특별한 맵을 만듬
      - 서로 다른 객체가 맞닿는 부분에 높은 가중치를 부여
      - 객체 내부나 배경 같이 구분이 쉬운 영역에는 낮은 가중치를 부여
    2. 가중치 손실 적용
      - 계산된 가중치 맵을 픽셀 단위 교차 엔트로피 코스트 함수에 적용
      - 가중치가 높은 영역에서 실수 했을때 훨씬 더 큰 페널티를 받게 됨
  - 효과
    - 모델이 페널티를 더 적게 받기 위해 가중치가 높은 어려운 경계 영역에 집중해서 학습하게 됨
    - 결과적으로, 네트워크는 서로 밀집해 있거나 맞닿아 있는 객체들을 분리하는 능력이 크게 향상




# 요약

- FCN
  - 핵심 아이디어:
    - FC 계층을 FCN 계층으로 교체
    - -> 임의의 입력 크기 수용, spatial information 유지
  - 업샘플링
    - 해상도 복원을 위한 디컨볼루션 계층
  - 스킵 아키텍쳐
    - 더 선명한 경계를 얻기 위해 깊은 시멘틱 정보와 얕은 공간 정보를 결합
  - 영향
    - 밀집 예측을 위한 최초의 end-to-end 학습

- U-Net
  - 아키텍쳐
    - 수축 경로와 확장 경로가 있는 U 자 형태.
  - 스킵연결
    - 정밀한 분할을 위해 인코더의 특징을 동일한 해상도의 디코더 특징에 연결
  - 학습 전략
    - 오버랩-타일: 큰 이미지처리를 위함
    - 미러링-외산법: 가장자리 픽셀의 컨텍스트 유지를 위함
    - 가중 손실: 맞닿은 객체 분리를 위함

- 통찰
  - 픽셀 단위의 작업에서는 공간 정보 보존이 매우 중요 -> 스킵 연결
  - 업샘플링 품질은 경계 정확도에 직접적인 영향을 미침
  - 전이 학습과 데이터 증강은 부족한 라벨 데이터를 극복하는데 도움을 줌